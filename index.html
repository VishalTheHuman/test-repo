<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biometric Auth (WebAuthn Platform Fingerprint)</title>
  <style>
    :root { --bg:#0b1020; --panel:#0f172a; --muted:#9ca3af; --text:#e5e7eb; --accent:#0ea5e9; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
    html, body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { background: var(--panel); border:1px solid #1f2937; border-radius: 12px; padding: 16px; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    p { color: var(--muted); margin: 4px 0 12px; }
    .row { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    button { appearance:none; border:1px solid #334155; background:#0b1327; color:var(--text); border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; }
    button.primary { border-color: var(--accent); background:#06243a; color:#cce8f7; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .status { margin-top:12px; padding:10px; border-radius:10px; border:1px solid #1f2937; background:#0b1327; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; word-break: break-word; }
    .pill { display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #1f2937; background:#0b1327; color:#cbd5e1; }
    .ok { color:#bbf7d0; border-color:#14532d; background:#052e1a; }
    .warn { color:#fde68a; border-color:#713f12; background:#2a1704; }
    .err { color:#fecaca; border-color:#7f1d1d; background:#2a0c0c; }
  </style>
  <meta name="description" content="Simple WebAuthn platform authenticator demo using fingerprint/Touch ID to register and authenticate on-device." />
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Biometric Auth — Platform Fingerprint (WebAuthn)</h1>
      <p>Register a passkey on this device, then authenticate using the platform authenticator (Android fingerprint, Touch ID). Requires HTTPS and a modern browser.</p>

      <div class="row" style="margin-bottom:8px;">
        <span id="supportPill" class="pill warn">Checking support…</span>
      </div>

      <div class="row" style="margin-bottom:8px;">
        <button id="btnGo" class="primary">Use fingerprint now</button>
        <button id="btnClear">Clear saved passkey</button>
      </div>

      <div class="status" id="log">Ready.</div>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const supportPill = document.getElementById('supportPill');
    const btnGo = document.getElementById('btnGo');
    const btnClear = document.getElementById('btnClear');

    const STORAGE_KEY = 'webauthn_demo_credential_id';
    const STORAGE_KEY_RAW = 'webauthn_demo_credential_raw';
    const STORAGE_USER = 'webauthn_demo_user';

    function log(msg, type) {
      if (type === 'ok') supportPill.className = 'pill ok';
      if (type === 'warn') supportPill.className = 'pill warn';
      if (type === 'err') supportPill.className = 'pill err';
      logEl.textContent = String(msg);
      if (typeof msg === 'object') logEl.textContent = JSON.stringify(msg, null, 2);
    }

    function b64urlToBuf(b64url) {
      const pad = '='.repeat((4 - (b64url.length % 4)) % 4);
      const base64 = (b64url + pad).replace(/-/g, '+').replace(/_/g, '/');
      const raw = atob(base64);
      const buf = new ArrayBuffer(raw.length);
      const arr = new Uint8Array(buf);
      for (let i = 0; i < raw.length; i++) arr[i] = raw.charCodeAt(i);
      return buf;
    }
    function bufToB64url(buf) {
      const bytes = new Uint8Array(buf);
      let str = '';
      for (let i = 0; i < bytes.length; i++) str += String.fromCharCode(bytes[i]);
      const base64 = btoa(str);
      return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
    }
    function randBuf(len) {
      const a = new Uint8Array(len);
      crypto.getRandomValues(a);
      return a.buffer;
    }

    async function checkAvailability() {
      if (!('PublicKeyCredential' in window)) {
        supportPill.textContent = 'WebAuthn not supported';
        supportPill.className = 'pill err';
        log('This browser does not support WebAuthn.', 'err');
        return false;
      }
      const hasPlatform = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().catch(() => false);
      if (hasPlatform) {
        supportPill.textContent = 'Platform authenticator available';
        supportPill.className = 'pill ok';
        log('Platform authenticator available (fingerprint/Touch ID).', 'ok');
      } else {
        supportPill.textContent = 'No platform authenticator';
        supportPill.className = 'pill warn';
        log('No platform authenticator reported. Try a device with Touch ID/Android fingerprint.', 'warn');
      }
      return hasPlatform;
    }

    async function registerCredential() {
      const rpId = location.hostname;
      const publicKey = {
        rp: { id: rpId, name: 'WebAuthn Demo' },
        user: {
          id: new TextEncoder().encode((Math.random() + 1).toString(36).slice(2)),
          name: 'demo@example.com',
          displayName: 'Demo User'
        },
        challenge: randBuf(32),
        pubKeyCredParams: [
          { type: 'public-key', alg: -7 },   // ES256
          { type: 'public-key', alg: -257 }  // RS256
        ],
        timeout: 60000,
        attestation: 'none',
        authenticatorSelection: {
          authenticatorAttachment: 'platform',
          residentKey: 'preferred',
          userVerification: 'required'
        }
      };
      const cred = await navigator.credentials.create({ publicKey });
      if (!cred) throw new Error('Creation returned null');

      const id = cred.id; // string
      const rawB64 = bufToB64url(cred.rawId);
      localStorage.setItem(STORAGE_KEY, id);
      localStorage.setItem(STORAGE_KEY_RAW, rawB64);
      localStorage.setItem(STORAGE_USER, publicKey.user.name);

      log({
        action: 'register:success',
        id,
        type: cred.type,
        rpId,
        user: publicKey.user.name
      }, 'ok');
    }

    async function authenticate() {
      const id = localStorage.getItem(STORAGE_KEY);
      const raw = localStorage.getItem(STORAGE_KEY_RAW);
      if (!id && !raw) {
        log('No credential stored. Register first.', 'warn');
        return;
      }
      const allowCredential = (id || raw) ? [{
        id: raw ? b64urlToBuf(raw) : b64urlToBuf(bufToB64url(new TextEncoder().encode(id))),
        type: 'public-key',
        transports: ['internal']
      }] : undefined;
      const publicKey = {
        challenge: randBuf(32),
        allowCredentials: allowCredential,
        timeout: 60000,
        userVerification: 'required'
      };
      const assertion = await navigator.credentials.get({ publicKey });
      if (!assertion) throw new Error('Assertion returned null');

      const ok = !!(assertion.response.authenticatorData && assertion.response.signature);
      log({
        action: 'authenticate:' + (ok ? 'success' : 'failed'),
        id: assertion.id,
        user: localStorage.getItem(STORAGE_USER) || 'unknown',
        signatureBytes: assertion.response.signature ? assertion.response.signature.byteLength : 0
      }, ok ? 'ok' : 'err');
    }

    function clearRegistration() {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(STORAGE_KEY_RAW);
      localStorage.removeItem(STORAGE_USER);
      log('Cleared stored credential id. Register again to continue.', 'warn');
    }

    btnGo.addEventListener('click', async () => {
      try {
        const ok = await checkAvailability();
        if (!ok) return;
        const has = !!(localStorage.getItem(STORAGE_KEY) || localStorage.getItem(STORAGE_KEY_RAW));
        if (!has) await registerCredential();
        await authenticate();
      } catch (e) {
        log('Error: ' + (e && e.message || e), 'err');
      }
    });
    btnClear.addEventListener('click', clearRegistration);

    // Initial check (non-blocking)
    checkAvailability();

    // Hints
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      log('Tip: WebAuthn requires HTTPS. Deploy to HTTPS or use localhost for testing.', 'warn');
    }
  </script>
</body>
</html>


